---
interface Props {
  title: string;
  description: string;
  images: string[];
  large?: boolean;
}

const base = import.meta.env.BASE_URL;
const { title, description, images, large = false } = Astro.props;
const imageSrcs = images.map((img) => (img.startsWith('/') ? `${base}${img}` : img));
const sliderId = `slider-${Math.random().toString(36).slice(2, 8)}`;
const hasMultiple = imageSrcs.length > 1;
---

<div
  class:list={[
    'group relative rounded-2xl overflow-hidden border border-white/[0.03] hover:border-white/[0.08] transition-all duration-700',
    large ? 'h-[260px] sm:h-[380px]' : 'h-[220px] sm:h-[300px]',
  ]}
  data-slider-id={sliderId}
  data-slider-count={imageSrcs.length}
>
  <!-- Background Images (stacked, crossfade via opacity + subtle Ken Burns zoom) -->
  {
    imageSrcs.map((src, i) => (
      <img
        src={src}
        alt={`${title} ${i + 1}`}
        class:list={['absolute inset-0 w-full h-full object-cover', i === 0 ? 'opacity-100' : 'opacity-0']}
        style="transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1), transform 6s cubic-bezier(0.4, 0, 0.2, 1);"
        data-slider-img={i}
      />
    ))
  }

  <!-- Dark gradient overlay -->
  <div
    class="absolute inset-0 bg-gradient-to-t from-dark-950 via-dark-950/60 via-40% to-dark-950/10 transition-opacity duration-500"
  >
  </div>

  <!-- Subtle top accent line on hover -->
  <div
    class="absolute top-0 left-6 right-6 h-px bg-gradient-to-r from-transparent via-accent-500/30 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700 z-10"
  >
  </div>

  <!-- Dot indicators (only when multiple images) -->
  {
    hasMultiple && (
      <div class="absolute top-2 right-2 flex gap-0 z-20">
        {imageSrcs.map((_, i) => (
          <button class="flex items-center justify-center w-7 h-7" data-slider-dot={i} aria-label={`Bild ${i + 1}`}>
            <span
              class:list={[
                'block w-1.5 h-1.5 rounded-full transition-all duration-700',
                i === 0 ? 'bg-white/90 scale-125' : 'bg-white/30',
              ]}
              data-slider-dot-inner={i}
            />
          </button>
        ))}
      </div>
    )
  }

  <!-- Content -->
  <div class="absolute inset-0 flex flex-col justify-end p-6 sm:p-8 z-10">
    <h3
      class:list={[
        'text-white font-bold font-heading mb-2 group-hover:text-accent-400 transition-colors duration-300',
        large ? 'text-xl sm:text-2xl' : 'text-lg sm:text-xl',
      ]}
    >
      {title}
    </h3>
    <p
      class:list={[
        'text-dark-300 leading-relaxed group-hover:text-dark-200 transition-colors duration-300',
        large ? 'text-sm sm:text-base max-w-md' : 'text-sm',
      ]}
    >
      {description}
    </p>

    <!-- Arrow hint on hover -->
    <div
      class="mt-4 flex items-center gap-2 text-accent-500/0 group-hover:text-accent-500 transition-all duration-700 translate-y-2 group-hover:translate-y-0"
    >
      <span class="text-sm font-medium">Mehr erfahren</span>
      <svg
        class="w-4 h-4 transition-transform group-hover:translate-x-1"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"></path>
      </svg>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-slider-id]').forEach((container) => {
      const count = parseInt(container.getAttribute('data-slider-count') || '1');
      if (count <= 1) return; // Single image â€” no slider needed

      const imgs = container.querySelectorAll('[data-slider-img]');
      const dots = container.querySelectorAll('[data-slider-dot-inner]');
      let current = 0;
      let interval;

      function goTo(idx) {
        // Fade out old, fade in new + subtle Ken Burns zoom
        imgs.forEach((img, i) => {
          if (i === idx) {
            img.style.opacity = '1';
            img.style.transform = 'scale(1.05)';
          } else {
            img.style.opacity = '0';
            img.style.transform = 'scale(1)';
          }
        });
        dots.forEach((dot, i) => {
          if (i === idx) {
            dot.style.background = 'rgba(255,255,255,0.9)';
            dot.style.transform = 'scale(1.3)';
          } else {
            dot.style.background = 'rgba(255,255,255,0.3)';
            dot.style.transform = 'scale(1)';
          }
        });
        current = idx;
      }

      function next() {
        goTo((current + 1) % count);
      }

      // Auto-advance every 4s
      function startAutoplay() {
        interval = setInterval(next, 4000);
      }

      // Pause on hover, resume on leave
      container.addEventListener('mouseenter', () => clearInterval(interval));
      container.addEventListener('mouseleave', startAutoplay);

      // Click dots to jump (listen on parent button)
      container.querySelectorAll('[data-slider-dot]').forEach((btn, i) => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          clearInterval(interval);
          goTo(i);
          startAutoplay();
        });
      });

      // Start with Ken Burns on first image
      imgs[0].style.transform = 'scale(1.05)';
      startAutoplay();
    });
  });
</script>
