---
import type { Service } from '../data/services';

interface Props {
  service: Service;
  index: number;
  total: number;
}

const base = import.meta.env.BASE_URL;
const { service, index, total } = Astro.props;
const hasImages = service.images && service.images.length > 0;
const hasGallery = service.gallery && service.gallery.length > 0;
const isReversed = index % 2 === 1;
const sectionId = service.title
  .toLowerCase()
  .replace(/[^a-z0-9]+/g, '-')
  .replace(/-+$/, '');
const galleryId = `gallery-${sectionId}`;

const gallerySrcs = hasGallery ? service.gallery!.map((img) => (img.startsWith('/') ? `${base}${img}` : img)) : [];

// Build image URLs with base path
const imageSrcs = hasImages ? service.images!.map((img) => (img.startsWith('/') ? `${base}${img}` : img)) : [];

// Icon SVG paths for services without images
const iconSvgMap: Record<string, string> = {
  trowel:
    '<path stroke-linecap="round" stroke-linejoin="round" d="M3 5h18v3H3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6v2a3 3 0 01-3 3 3 3 0 01-3-3v-2z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 17v3" />',
  roller:
    '<rect x="4" y="3" width="14" height="5" rx="1" stroke-linecap="round" stroke-linejoin="round" /><path stroke-linecap="round" stroke-linejoin="round" d="M18 5.5h2v3h-8v2" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 10.5v3" /><rect x="10" y="13.5" width="4" height="7" rx="1" stroke-linecap="round" stroke-linejoin="round" />',
  floor:
    '<path stroke-linecap="round" stroke-linejoin="round" d="M3 8l9-5 9 5" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 8v4l9 5 9-5V8" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 12v4l9 5 9-5v-4" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 7v5m0 4v5" />',
  facade:
    '<path stroke-linecap="round" stroke-linejoin="round" d="M12 3l9 6v12H3V9l9-6z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 21v-6h6v6" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 10h1.5m3 0H15" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h1.5m3 0H15" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 9v12m12-12v12" />',
  bath: '<path stroke-linecap="round" stroke-linejoin="round" d="M4 12h16M4 12v6a2 2 0 002 2h12a2 2 0 002-2v-6M4 12V8a4 4 0 014-4h1" /><path stroke-linecap="round" stroke-linejoin="round" d="M7 20v1m10-1v1" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 4v4" />',
  tiles:
    '<rect x="3" y="3" width="8" height="8" rx="0.5" /><rect x="13" y="3" width="8" height="8" rx="0.5" /><rect x="3" y="13" width="8" height="8" rx="0.5" /><rect x="13" y="13" width="8" height="8" rx="0.5" /><circle cx="7" cy="7" r="1" fill="currentColor" stroke="none" /><circle cx="17" cy="7" r="1" fill="currentColor" stroke="none" /><circle cx="7" cy="17" r="1" fill="currentColor" stroke="none" /><circle cx="17" cy="17" r="1" fill="currentColor" stroke="none" />',
  ceiling:
    '<path stroke-linecap="round" stroke-linejoin="round" d="M3 4h18" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 4v4m4-4v4m4-4v4m4-4v4" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 8h18" /><rect x="4" y="8" width="7" height="5" rx="0.5" /><rect x="13" y="8" width="7" height="5" rx="0.5" /><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 15v3m0 0l-2 2m2-2l2 2" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 15v3m0 0l-2 2m2-2l2 2" />',
  wrench:
    '<path stroke-linecap="round" stroke-linejoin="round" d="M14.5 3l-1 3h-3l-1-3h5z" /><rect x="9.5" y="6" width="5" height="10" rx="1" /><path stroke-linecap="round" stroke-linejoin="round" d="M11 16h2v5h-2z" /><path stroke-linecap="round" stroke-linejoin="round" d="M11.5 9h1m-1 2.5h1" /><circle cx="12" cy="21" r="0.5" fill="currentColor" stroke="none" />',
  tools:
    '<path stroke-linecap="round" stroke-linejoin="round" d="M14 3c2 0 4 1 5 3l-4.5 4.5L17 13l4.5-4.5c.5 1.5.3 3.5-1 5-1.5 1.5-3.5 2-5.2 1.5l-7.3 7.3a2 2 0 01-2.8 0l-.2-.2a2 2 0 010-2.8l7.3-7.3C11.8 10.5 12 8.5 13.5 7c.5-.5 1-1 1.5-1.2" /><circle cx="6.5" cy="19.5" r="0.75" fill="currentColor" stroke="none" />',
};
---

<section
  id={sectionId}
  class="service-section relative min-h-screen flex items-center overflow-hidden"
  data-section-index={index}
>
  {/* === Background === */}
  {
    hasImages ? (
      <div class="absolute inset-0">
        {/* Primary image */}
        <img
          src={imageSrcs[0]}
          alt={service.title}
          class="w-full h-full object-cover service-parallax-img"
          loading={index < 2 ? 'eager' : 'lazy'}
        />
        {/* Dark overlay — gradient depends on layout direction */}
        <div
          class:list={[
            'absolute inset-0',
            isReversed
              ? 'bg-gradient-to-l from-dark-950 from-30% via-dark-950/85 via-55% to-dark-950/20'
              : 'bg-gradient-to-r from-dark-950 from-30% via-dark-950/85 via-55% to-dark-950/20',
          ]}
        />
        {/* Additional vertical gradients */}
        <div class="absolute inset-0 bg-gradient-to-t from-dark-950/80 via-transparent via-50% to-dark-950/40" />
      </div>
    ) : (
      <div class="absolute inset-0 bg-dark-900">
        {/* Geometric accent elements for icon-only sections */}
        <div
          class:list={[
            'absolute w-[500px] h-[500px] rounded-full blur-[120px] opacity-[0.07]',
            isReversed ? '-top-32 -left-32 bg-accent-500' : '-bottom-32 -right-32 bg-accent-500',
          ]}
        />
        <div
          class:list={[
            'absolute w-[300px] h-[300px] rounded-full blur-[80px] opacity-[0.04]',
            isReversed ? 'bottom-20 right-20 bg-white' : 'top-20 left-20 bg-white',
          ]}
        />
        {/* Subtle grid pattern */}
        <div
          class="absolute inset-0 opacity-[0.02]"
          style="background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 60px 60px;"
        />
        {/* Top/Bottom section borders */}
        <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/[0.06] to-transparent" />
      </div>
    )
  }

  {/* === Content === */}
  <div class="relative z-10 max-w-7xl mx-auto px-5 sm:px-6 lg:px-8 py-20 sm:py-28 w-full">
    <div class:list={['flex flex-col lg:flex-row items-center gap-12 lg:gap-20', isReversed && 'lg:flex-row-reverse']}>
      {/* --- Visual side (image gallery or large icon) --- */}
      <div class="w-full lg:w-1/2 service-reveal">
        {
          hasImages ? (
            <div class="cinema-gallery relative">
              {/* Corner accent marks — top-left and bottom-right */}
              <div class="absolute -top-2 -left-2 w-8 h-8 z-20 pointer-events-none">
                <div class="absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r from-accent-500 to-transparent" />
                <div class="absolute top-0 left-0 h-full w-[2px] bg-gradient-to-b from-accent-500 to-transparent" />
              </div>
              <div class="absolute -bottom-2 -right-2 w-8 h-8 z-20 pointer-events-none">
                <div class="absolute bottom-0 right-0 w-full h-[2px] bg-gradient-to-l from-accent-500 to-transparent" />
                <div class="absolute bottom-0 right-0 h-full w-[2px] bg-gradient-to-t from-accent-500 to-transparent" />
              </div>

              {/* Animated gradient border */}
              <div class="absolute -inset-[1px] rounded-2xl cinema-border-glow z-10 pointer-events-none" />

              {/* Frame */}
              <div class="relative rounded-2xl overflow-hidden aspect-[4/3] bg-dark-900 shadow-[0_20px_60px_-15px_rgba(0,0,0,0.6)]">
                {/* Images with Ken Burns */}
                {imageSrcs.map((src, i) => {
                  // Each image gets a unique Ken Burns direction
                  const kenBurns = ['kb-zoom-left', 'kb-zoom-right', 'kb-zoom-center', 'kb-zoom-left'][i % 4];

                  return (
                    <div class:list={['cinema-slide absolute inset-0', i === 0 ? 'is-active' : '']} data-slide={i}>
                      <img
                        src={src}
                        alt={`${service.title} ${i + 1}`}
                        class:list={['w-full h-full object-cover', kenBurns]}
                        data-gallery-img={i}
                        loading="lazy"
                      />
                    </div>
                  );
                })}

                {/* Vignette + accent edge glow */}
                <div
                  class="absolute inset-0 pointer-events-none z-10"
                  style="box-shadow: inset 0 0 80px rgba(0,0,0,0.3), inset 0 0 1px rgba(212,175,55,0.15);"
                />
              </div>

              {/* Controls below */}
              {imageSrcs.length > 1 && (
                <div class="flex items-center gap-5 mt-5 px-1">
                  {/* Thin progress lines */}
                  <div class="flex gap-2 flex-1">
                    {imageSrcs.map((_, i) => (
                      <button
                        class:list={[
                          'service-gallery-dot relative h-[3px] flex-1 rounded-full cursor-pointer overflow-hidden transition-colors duration-300',
                          i === 0 ? 'bg-white/15' : 'bg-white/[0.06] hover:bg-white/10',
                        ]}
                        data-gallery-dot={i}
                      >
                        {i === 0 && (
                          <div
                            class="slider-progress absolute inset-y-0 left-0 bg-accent-500 rounded-full"
                            style="width: 0%"
                          />
                        )}
                      </button>
                    ))}
                  </div>
                  {/* Counter */}
                  <span class="text-white/30 text-xs font-mono tracking-wider slider-counter" data-slider-counter>
                    01 / {String(imageSrcs.length).padStart(2, '0')}
                  </span>
                </div>
              )}
            </div>
          ) : (
            <div class="cinema-gallery relative">
              {/* Corner accent marks */}
              <div class="absolute -top-2 -left-2 w-8 h-8 z-20 pointer-events-none">
                <div class="absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r from-accent-500 to-transparent" />
                <div class="absolute top-0 left-0 h-full w-[2px] bg-gradient-to-b from-accent-500 to-transparent" />
              </div>
              <div class="absolute -bottom-2 -right-2 w-8 h-8 z-20 pointer-events-none">
                <div class="absolute bottom-0 right-0 w-full h-[2px] bg-gradient-to-l from-accent-500 to-transparent" />
                <div class="absolute bottom-0 right-0 h-full w-[2px] bg-gradient-to-t from-accent-500 to-transparent" />
              </div>

              {/* Animated gradient border */}
              <div class="absolute -inset-[1px] rounded-2xl cinema-border-glow z-10 pointer-events-none" />

              {/* Icon frame — same aspect ratio and shadow as image gallery */}
              <div class="relative rounded-2xl overflow-hidden aspect-[4/3] bg-dark-900 shadow-[0_20px_60px_-15px_rgba(0,0,0,0.6)] flex items-center justify-center">
                {/* Animated background pattern */}
                <div
                  class="absolute inset-0 opacity-[0.03]"
                  style="background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 40px 40px;"
                />

                {/* Radial glow behind icon */}
                <div
                  class="absolute inset-0 bg-radial-gradient pointer-events-none"
                  style="background: radial-gradient(circle at center, rgba(212,175,55,0.08) 0%, transparent 60%);"
                />

                {/* Large icon */}
                <div class="relative">
                  <div class="absolute -inset-8 rounded-full bg-accent-500/5 blur-2xl" />
                  <div class="relative w-28 h-28 sm:w-36 sm:h-36 rounded-2xl bg-gradient-to-br from-dark-800/60 to-dark-800/20 border border-accent-500/15 flex items-center justify-center">
                    <svg
                      class="w-16 h-16 sm:w-20 sm:h-20 text-accent-500"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="1"
                    >
                      <Fragment set:html={iconSvgMap[service.icon] || iconSvgMap.tools} />
                    </svg>
                  </div>
                </div>

                {/* Vignette */}
                <div
                  class="absolute inset-0 pointer-events-none"
                  style="box-shadow: inset 0 0 80px rgba(0,0,0,0.3), inset 0 0 1px rgba(212,175,55,0.15);"
                />
              </div>
            </div>
          )
        }
      </div>

      {/* --- Text side --- */}
      <div class="w-full lg:w-1/2 service-reveal">
        {/* Section number */}
        <div class="flex items-center gap-3 mb-6">
          <span class="text-accent-500/40 text-sm font-mono font-medium tracking-widest">
            {String(index + 1).padStart(2, '0')} / {String(total).padStart(2, '0')}
          </span>
          <div class="h-px flex-1 max-w-16 bg-accent-500/30"></div>
        </div>

        {/* Title */}
        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-6 font-heading leading-tight">
          {service.title}
        </h2>

        {/* Long description */}
        <p class="text-dark-300 text-base sm:text-lg leading-relaxed mb-8">
          {service.longDescription}
        </p>

        {/* Features list */}
        <ul class="space-y-3 mb-10">
          {
            service.features.map((feature) => (
              <li class="flex items-center gap-3 text-dark-200">
                <div class="w-5 h-5 rounded-full bg-accent-500/15 flex items-center justify-center shrink-0">
                  <svg
                    class="w-3 h-3 text-accent-500"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="3"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                  </svg>
                </div>
                <span class="text-sm sm:text-base">{feature}</span>
              </li>
            ))
          }
        </ul>

        {/* CTAs */}
        <div class="flex flex-wrap items-center gap-3">
          <a
            href={`${base}/kontakt`}
            class="inline-flex items-center gap-2 px-7 py-3.5 bg-accent-500 hover:bg-accent-400 text-dark-950 rounded-xl text-sm font-semibold transition-all duration-300 hover:shadow-lg hover:shadow-accent-500/25 hover:-translate-y-0.5"
          >
            Jetzt anfragen
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"></path>
            </svg>
          </a>
          {
            hasGallery && (
              <button
                class="gallery-open-btn inline-flex items-center gap-2 px-7 py-3.5 bg-white/5 hover:bg-white/10 text-white border border-white/10 rounded-xl text-sm font-semibold transition-all duration-300 hover:-translate-y-0.5 cursor-pointer"
                data-gallery-open={galleryId}
              >
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.41a2.25 2.25 0 013.182 0l2.909 2.91m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
                  />
                </svg>
                Galerie ({gallerySrcs.length})
              </button>
            )
          }
        </div>
      </div>
    </div>
  </div>
</section>

{/* === Gallery Lightbox Overlay === */}
{
  hasGallery && (
    <div id={galleryId} class="gallery-overlay fixed inset-0 z-[100] hidden opacity-0 transition-opacity duration-300">
      {/* Backdrop */}
      <div
        class="absolute inset-0 bg-dark-950/95 backdrop-blur-sm gallery-close-btn cursor-pointer"
        data-gallery-close={galleryId}
      />

      {/* Content */}
      <div class="relative z-10 h-full flex flex-col">
        {/* Header */}
        <div class="flex items-center justify-between px-5 sm:px-8 py-4 border-b border-white/[0.06]">
          <div>
            <h3 class="text-white font-semibold text-lg font-heading">{service.title}</h3>
            <p class="text-dark-400 text-sm">{gallerySrcs.length} Bilder</p>
          </div>
          <button
            class="gallery-close-btn p-2 rounded-lg hover:bg-white/10 transition-colors text-white/60 hover:text-white cursor-pointer"
            data-gallery-close={galleryId}
          >
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Image Grid */}
        <div class="flex-1 overflow-y-auto px-5 sm:px-8 py-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-w-6xl mx-auto">
            {gallerySrcs.map((src, i) => (
              <button
                class="gallery-thumb group relative rounded-xl overflow-hidden aspect-[4/3] cursor-pointer border border-white/[0.06] hover:border-accent-500/30 transition-all duration-300"
                data-lightbox-src={src}
                data-lightbox-gallery={galleryId}
                data-lightbox-index={i}
              >
                <img
                  src={src}
                  alt={`${service.title} ${i + 1}`}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                  loading="lazy"
                />
                <div class="absolute inset-0 bg-dark-950/0 group-hover:bg-dark-950/20 transition-colors duration-300" />
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Fullscreen Lightbox (single image view) */}
      <div
        class="lightbox-single hidden fixed inset-0 z-[110] flex items-center justify-center"
        data-lightbox-single={galleryId}
      >
        <div
          class="absolute inset-0 bg-dark-950/98 cursor-pointer lightbox-single-close"
          data-lightbox-single-close={galleryId}
        />
        <button
          class="absolute top-4 right-4 z-20 p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors text-white cursor-pointer lightbox-single-close"
          data-lightbox-single-close={galleryId}
        >
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        {/* Navigation arrows */}
        <button
          class="lightbox-prev absolute left-4 z-20 p-3 rounded-full bg-white/10 hover:bg-white/20 transition-colors text-white cursor-pointer"
          data-lightbox-prev={galleryId}
        >
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
          </svg>
        </button>
        <button
          class="lightbox-next absolute right-4 z-20 p-3 rounded-full bg-white/10 hover:bg-white/20 transition-colors text-white cursor-pointer"
          data-lightbox-next={galleryId}
        >
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
          </svg>
        </button>
        <img
          class="lightbox-img relative z-10 max-w-[90vw] max-h-[85vh] object-contain rounded-lg"
          data-lightbox-img={galleryId}
          src=""
          alt=""
        />
        <div
          class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 text-white/50 text-sm font-mono lightbox-counter"
          data-lightbox-counter={galleryId}
        />
      </div>
    </div>
  )
}

<style is:global>
  /* === Scroll-triggered reveal animation === */
  .service-reveal {
    opacity: 0;
    transform: translateY(40px);
    transition:
      opacity 0.8s cubic-bezier(0.22, 1, 0.36, 1),
      transform 0.8s cubic-bezier(0.22, 1, 0.36, 1);
  }
  .service-reveal.revealed {
    opacity: 1;
    transform: translateY(0);
  }
  /* Stagger the second element */
  .service-section .service-reveal:nth-child(2) {
    transition-delay: 0.15s;
  }

  /* === Kein Zoom-Effekt auf Hintergrundbilder === */
  .service-parallax-img {
    transform: scale(1);
  }

  /* === Cinema gallery: clip-path reveal === */
  .cinema-slide {
    clip-path: inset(0 0 0 100%);
    z-index: 1;
    transition: none;
  }
  .cinema-slide.is-active {
    clip-path: inset(0 0 0 0%);
    z-index: 2;
  }
  .cinema-slide.is-revealing {
    clip-path: inset(0 0 0 0%);
    z-index: 3;
    transition: clip-path 1s cubic-bezier(0.76, 0, 0.24, 1);
  }
  .cinema-slide.is-leaving {
    clip-path: inset(0 0 0 0%);
    z-index: 2;
  }

  /* === Ken Burns: slow zoom + pan per image === */
  .cinema-slide.is-active img,
  .cinema-slide.is-revealing img {
    animation-duration: 8s;
    animation-timing-function: ease-out;
    animation-fill-mode: forwards;
  }
  .kb-zoom-left {
    animation-name: kbZoomLeft;
  }
  .kb-zoom-right {
    animation-name: kbZoomRight;
  }
  .kb-zoom-center {
    animation-name: kbZoomCenter;
  }

  @keyframes kbZoomLeft {
    from {
      transform: scale(1.12) translateX(2%);
    }
    to {
      transform: scale(1) translateX(-1%);
    }
  }
  @keyframes kbZoomRight {
    from {
      transform: scale(1.12) translateX(-2%);
    }
    to {
      transform: scale(1) translateX(1%);
    }
  }
  @keyframes kbZoomCenter {
    from {
      transform: scale(1.15);
    }
    to {
      transform: scale(1);
    }
  }

  /* === Animated gradient border around image === */
  .cinema-border-glow {
    background: conic-gradient(
      from var(--border-angle, 0deg),
      transparent 0%,
      rgba(212, 175, 55, 0.25) 10%,
      transparent 20%,
      transparent 80%,
      rgba(212, 175, 55, 0.15) 90%,
      transparent 100%
    );
    animation: rotateBorder 8s linear infinite;
    mask:
      linear-gradient(#fff 0 0) content-box,
      linear-gradient(#fff 0 0);
    mask-composite: exclude;
    -webkit-mask-composite: xor;
    padding: 1px;
  }
  @property --border-angle {
    syntax: '<angle>';
    initial-value: 0deg;
    inherits: false;
  }
  @keyframes rotateBorder {
    to {
      --border-angle: 360deg;
    }
  }

  /* === Slider progress bar === */
  .slider-progress {
    transition: width 30ms linear;
  }

  /* === Mobile: no parallax, smaller spacing === */
  @media (max-width: 639px) {
    .service-section {
      min-height: auto;
      padding-top: 4rem;
      padding-bottom: 4rem;
    }
  }

  /* === Gallery Overlay === */
  .gallery-overlay.open {
    display: flex;
    flex-direction: column;
  }
  .gallery-overlay.visible {
    opacity: 1;
  }
</style>

<script>
  // === Scroll reveal ===
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('revealed');
        }
      });
    },
    { threshold: 0.15, rootMargin: '0px 0px -50px 0px' },
  );

  document.querySelectorAll('.service-reveal').forEach((el) => observer.observe(el));

  // === Zoom-in effect when section enters view ===
  const zoomObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('in-view');
        }
      });
    },
    { threshold: 0.1 },
  );
  document.querySelectorAll('.service-section').forEach((el) => zoomObserver.observe(el));

  // === Cinema gallery with clip-path reveal + Ken Burns ===
  const SLIDE_DURATION = 6000;

  document.querySelectorAll('.service-section').forEach((section) => {
    const slides = section.querySelectorAll<HTMLElement>('.cinema-slide');
    const dots = section.querySelectorAll<HTMLElement>('.service-gallery-dot');
    const counter = section.querySelector<HTMLElement>('[data-slider-counter]');
    if (slides.length <= 1) return;

    let current = 0;
    let interval: ReturnType<typeof setInterval>;
    let progressInterval: ReturnType<typeof setInterval>;
    let isAnimating = false;

    function goTo(idx: number) {
      if (isAnimating || idx === current) return;
      isAnimating = true;

      const incoming = slides[idx];
      const outgoing = slides[current];

      // Reset incoming: prepare off-screen (clipped)
      incoming.classList.remove('is-active', 'is-leaving');
      incoming.classList.add('is-revealing');

      // Outgoing stays visible behind the reveal
      outgoing.classList.remove('is-active');
      outgoing.classList.add('is-leaving');

      // Restart Ken Burns animation on incoming image
      const inImg = incoming.querySelector('img');
      if (inImg) {
        const cls = inImg.className;
        inImg.className = '';
        void inImg.offsetWidth; // force reflow
        inImg.className = cls;
      }

      // After transition completes
      const onDone = () => {
        incoming.removeEventListener('transitionend', onDone);
        outgoing.classList.remove('is-leaving');
        incoming.classList.remove('is-revealing');
        incoming.classList.add('is-active');
        current = idx;
        isAnimating = false;
      };
      incoming.addEventListener('transitionend', onDone, { once: true });

      // Fallback in case transitionend doesn't fire
      setTimeout(() => {
        if (isAnimating) {
          onDone();
        }
      }, 1200);

      // Update progress dots
      dots.forEach((dot, i) => {
        const prog = dot.querySelector<HTMLElement>('.slider-progress');
        if (prog) prog.remove();

        if (i === idx) {
          dot.classList.add('bg-white/15');
          dot.classList.remove('bg-white/[0.06]', 'hover:bg-white/10');
          const bar = document.createElement('div');
          bar.className = 'slider-progress absolute inset-y-0 left-0 bg-accent-500 rounded-full';
          bar.style.width = '0%';
          dot.appendChild(bar);
        } else {
          dot.classList.remove('bg-white/15');
          dot.classList.add('bg-white/[0.06]', 'hover:bg-white/10');
        }
      });

      if (counter) {
        counter.textContent = `${String(idx + 1).padStart(2, '0')} / ${String(slides.length).padStart(2, '0')}`;
      }

      startProgress(idx);
    }

    function startProgress(idx: number) {
      clearInterval(progressInterval);
      const dot = dots[idx];
      const bar = dot?.querySelector<HTMLElement>('.slider-progress');
      if (!bar) return;
      bar.style.width = '0%';
      let elapsed = 0;
      const step = 30;
      progressInterval = setInterval(() => {
        elapsed += step;
        bar.style.width = `${Math.min((elapsed / SLIDE_DURATION) * 100, 100)}%`;
      }, step);
    }

    function startAutoplay() {
      clearInterval(interval);
      interval = setInterval(() => {
        goTo((current + 1) % slides.length);
      }, SLIDE_DURATION);
      startProgress(current);
    }

    function resetAutoplay() {
      clearInterval(interval);
      clearInterval(progressInterval);
      startAutoplay();
    }

    dots.forEach((dot, i) => {
      dot.addEventListener('click', () => {
        goTo(i);
        resetAutoplay();
      });
    });

    startAutoplay();
  });

  // === Gallery open/close ===
  document.querySelectorAll<HTMLElement>('[data-gallery-open]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.galleryOpen!;
      const overlay = document.getElementById(id);
      if (!overlay) return;
      overlay.classList.add('open');
      document.body.style.overflow = 'hidden';
      requestAnimationFrame(() => {
        requestAnimationFrame(() => overlay.classList.add('visible'));
      });
    });
  });

  function closeGallery(id: string) {
    const overlay = document.getElementById(id);
    if (!overlay) return;
    overlay.classList.remove('visible');
    document.body.style.overflow = '';
    // Also close single lightbox
    const single = overlay.querySelector<HTMLElement>('[data-lightbox-single]');
    if (single) single.classList.add('hidden');
    setTimeout(() => overlay.classList.remove('open'), 300);
  }

  document.querySelectorAll<HTMLElement>('[data-gallery-close]').forEach((btn) => {
    btn.addEventListener('click', () => closeGallery(btn.dataset.galleryClose!));
  });

  // === Lightbox: single image view ===
  document.querySelectorAll<HTMLElement>('.gallery-thumb').forEach((thumb) => {
    thumb.addEventListener('click', () => {
      const galleryId = thumb.dataset.lightboxGallery!;
      const index = parseInt(thumb.dataset.lightboxIndex || '0');
      openLightbox(galleryId, index);
    });
  });

  function openLightbox(galleryId: string, index: number) {
    const overlay = document.getElementById(galleryId);
    if (!overlay) return;
    const single = overlay.querySelector<HTMLElement>(`[data-lightbox-single="${galleryId}"]`);
    const img = overlay.querySelector<HTMLImageElement>(`[data-lightbox-img="${galleryId}"]`);
    const counter = overlay.querySelector<HTMLElement>(`[data-lightbox-counter="${galleryId}"]`);
    const thumbs = overlay.querySelectorAll<HTMLElement>('.gallery-thumb');
    if (!single || !img) return;

    img.src = thumbs[index]?.dataset.lightboxSrc || '';
    img.alt = `Bild ${index + 1}`;
    if (counter) counter.textContent = `${index + 1} / ${thumbs.length}`;
    single.classList.remove('hidden');
    single.dataset.currentIndex = String(index);
  }

  // Close single lightbox
  document.querySelectorAll<HTMLElement>('[data-lightbox-single-close]').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const galleryId = btn.dataset.lightboxSingleClose!;
      const overlay = document.getElementById(galleryId);
      if (!overlay) return;
      const single = overlay.querySelector<HTMLElement>(`[data-lightbox-single="${galleryId}"]`);
      if (single) single.classList.add('hidden');
    });
  });

  // Navigate prev/next
  document.querySelectorAll<HTMLElement>('[data-lightbox-prev]').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const galleryId = btn.dataset.lightboxPrev!;
      navigateLightbox(galleryId, -1);
    });
  });

  document.querySelectorAll<HTMLElement>('[data-lightbox-next]').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const galleryId = btn.dataset.lightboxNext!;
      navigateLightbox(galleryId, 1);
    });
  });

  function navigateLightbox(galleryId: string, direction: number) {
    const overlay = document.getElementById(galleryId);
    if (!overlay) return;
    const single = overlay.querySelector<HTMLElement>(`[data-lightbox-single="${galleryId}"]`);
    const thumbs = overlay.querySelectorAll<HTMLElement>('.gallery-thumb');
    if (!single) return;
    const current = parseInt(single.dataset.currentIndex || '0');
    const next = (current + direction + thumbs.length) % thumbs.length;
    openLightbox(galleryId, next);
  }

  // Close on Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll<HTMLElement>('.gallery-overlay.open').forEach((overlay) => {
        closeGallery(overlay.id);
      });
    }
  });
</script>
