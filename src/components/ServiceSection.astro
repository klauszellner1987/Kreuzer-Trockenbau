---
import type { Service } from '../data/services';

interface Props {
  service: Service;
  index: number;
  total: number;
}

const base = import.meta.env.BASE_URL;
const { service, index, total } = Astro.props;
const hasImages = service.images && service.images.length > 0;
const isReversed = index % 2 === 1;
const sectionId = service.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/, '');

// Build image URLs with base path
const imageSrcs = hasImages
  ? service.images!.map(img => img.startsWith('/') ? `${base}${img}` : img)
  : [];

// Icon SVG paths for services without images
const iconSvgMap: Record<string, string> = {
  trowel: '<path stroke-linecap="round" stroke-linejoin="round" d="M3 5h18v3H3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6v2a3 3 0 01-3 3 3 3 0 01-3-3v-2z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 17v3" />',
  roller: '<rect x="4" y="3" width="14" height="5" rx="1" stroke-linecap="round" stroke-linejoin="round" /><path stroke-linecap="round" stroke-linejoin="round" d="M18 5.5h2v3h-8v2" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 10.5v3" /><rect x="10" y="13.5" width="4" height="7" rx="1" stroke-linecap="round" stroke-linejoin="round" />',
  floor: '<path stroke-linecap="round" stroke-linejoin="round" d="M3 8l9-5 9 5" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 8v4l9 5 9-5V8" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 12v4l9 5 9-5v-4" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 7v5m0 4v5" />',
  facade: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 3l9 6v12H3V9l9-6z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 21v-6h6v6" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 10h1.5m3 0H15" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h1.5m3 0H15" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 9v12m12-12v12" />',
  bath: '<path stroke-linecap="round" stroke-linejoin="round" d="M4 12h16M4 12v6a2 2 0 002 2h12a2 2 0 002-2v-6M4 12V8a4 4 0 014-4h1" /><path stroke-linecap="round" stroke-linejoin="round" d="M7 20v1m10-1v1" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 4v4" />',
  tiles: '<rect x="3" y="3" width="8" height="8" rx="0.5" /><rect x="13" y="3" width="8" height="8" rx="0.5" /><rect x="3" y="13" width="8" height="8" rx="0.5" /><rect x="13" y="13" width="8" height="8" rx="0.5" /><circle cx="7" cy="7" r="1" fill="currentColor" stroke="none" /><circle cx="17" cy="7" r="1" fill="currentColor" stroke="none" /><circle cx="7" cy="17" r="1" fill="currentColor" stroke="none" /><circle cx="17" cy="17" r="1" fill="currentColor" stroke="none" />',
  ceiling: '<path stroke-linecap="round" stroke-linejoin="round" d="M3 4h18" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 4v4m4-4v4m4-4v4m4-4v4" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 8h18" /><rect x="4" y="8" width="7" height="5" rx="0.5" /><rect x="13" y="8" width="7" height="5" rx="0.5" /><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 15v3m0 0l-2 2m2-2l2 2" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 15v3m0 0l-2 2m2-2l2 2" />',
  wrench: '<path stroke-linecap="round" stroke-linejoin="round" d="M14.5 3l-1 3h-3l-1-3h5z" /><rect x="9.5" y="6" width="5" height="10" rx="1" /><path stroke-linecap="round" stroke-linejoin="round" d="M11 16h2v5h-2z" /><path stroke-linecap="round" stroke-linejoin="round" d="M11.5 9h1m-1 2.5h1" /><circle cx="12" cy="21" r="0.5" fill="currentColor" stroke="none" />',
  tools: '<path stroke-linecap="round" stroke-linejoin="round" d="M14 3c2 0 4 1 5 3l-4.5 4.5L17 13l4.5-4.5c.5 1.5.3 3.5-1 5-1.5 1.5-3.5 2-5.2 1.5l-7.3 7.3a2 2 0 01-2.8 0l-.2-.2a2 2 0 010-2.8l7.3-7.3C11.8 10.5 12 8.5 13.5 7c.5-.5 1-1 1.5-1.2" /><circle cx="6.5" cy="19.5" r="0.75" fill="currentColor" stroke="none" />',
};
---

<section
  id={sectionId}
  class="service-section relative min-h-screen flex items-center overflow-hidden"
  data-section-index={index}
>
  {/* === Background === */}
  {hasImages ? (
    <div class="absolute inset-0">
      {/* Primary image */}
      <img
        src={imageSrcs[0]}
        alt={service.title}
        class="w-full h-full object-cover service-parallax-img"
        loading={index < 2 ? 'eager' : 'lazy'}
      />
      {/* Dark overlay â€” gradient depends on layout direction */}
      <div class:list={[
        'absolute inset-0',
        isReversed
          ? 'bg-gradient-to-l from-dark-950 from-30% via-dark-950/85 via-55% to-dark-950/20'
          : 'bg-gradient-to-r from-dark-950 from-30% via-dark-950/85 via-55% to-dark-950/20',
      ]} />
      {/* Additional vertical gradients */}
      <div class="absolute inset-0 bg-gradient-to-t from-dark-950/80 via-transparent via-50% to-dark-950/40" />
    </div>
  ) : (
    <div class="absolute inset-0 bg-dark-900">
      {/* Geometric accent elements for icon-only sections */}
      <div class:list={[
        'absolute w-[500px] h-[500px] rounded-full blur-[120px] opacity-[0.07]',
        isReversed ? '-top-32 -left-32 bg-accent-500' : '-bottom-32 -right-32 bg-accent-500',
      ]} />
      <div class:list={[
        'absolute w-[300px] h-[300px] rounded-full blur-[80px] opacity-[0.04]',
        isReversed ? 'bottom-20 right-20 bg-white' : 'top-20 left-20 bg-white',
      ]} />
      {/* Subtle grid pattern */}
      <div class="absolute inset-0 opacity-[0.02]" style="background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 60px 60px;" />
      {/* Top/Bottom section borders */}
      <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/[0.06] to-transparent" />
    </div>
  )}

  {/* === Content === */}
  <div class="relative z-10 max-w-7xl mx-auto px-5 sm:px-6 lg:px-8 py-20 sm:py-28 w-full">
    <div class:list={[
      'flex flex-col lg:flex-row items-center gap-12 lg:gap-20',
      isReversed && 'lg:flex-row-reverse',
    ]}>

      {/* --- Visual side (image gallery or large icon) --- */}
      <div class="w-full lg:w-1/2 service-reveal">
        {hasImages ? (
          <div class="relative">
            {/* Image count badge */}
            {imageSrcs.length > 1 && (
              <div class="absolute top-4 right-4 z-20 flex gap-1.5">
                {imageSrcs.map((_, i) => (
                  <button
                    class:list={[
                      'service-gallery-dot w-2 h-2 rounded-full transition-all duration-500',
                      i === 0 ? 'bg-accent-500 scale-125' : 'bg-white/30',
                    ]}
                    data-gallery-dot={i}
                  />
                ))}
              </div>
            )}
            {/* Gallery images */}
            <div class="relative rounded-2xl overflow-hidden aspect-[4/3] shadow-2xl shadow-black/30 border border-white/[0.06]">
              {imageSrcs.map((src, i) => (
                <img
                  src={src}
                  alt={`${service.title} ${i + 1}`}
                  class:list={[
                    'service-gallery-img absolute inset-0 w-full h-full object-cover transition-opacity duration-1000',
                    i === 0 ? 'opacity-100' : 'opacity-0',
                  ]}
                  data-gallery-img={i}
                  loading="lazy"
                />
              ))}
            </div>
          </div>
        ) : (
          <div class="flex items-center justify-center">
            <div class="relative">
              {/* Glowing ring behind icon */}
              <div class="absolute inset-0 w-40 h-40 sm:w-52 sm:h-52 rounded-full bg-accent-500/10 blur-xl animate-pulse" />
              {/* Icon container */}
              <div class="relative w-40 h-40 sm:w-52 sm:h-52 rounded-3xl bg-gradient-to-br from-dark-800/80 to-dark-800/40 border border-accent-500/20 flex items-center justify-center backdrop-blur-sm">
                <svg class="w-20 h-20 sm:w-28 sm:h-28 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                  <Fragment set:html={iconSvgMap[service.icon] || iconSvgMap.tools} />
                </svg>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* --- Text side --- */}
      <div class="w-full lg:w-1/2 service-reveal">
        {/* Section number */}
        <div class="flex items-center gap-3 mb-6">
          <span class="text-accent-500/40 text-sm font-mono font-medium tracking-widest">
            {String(index + 1).padStart(2, '0')} / {String(total).padStart(2, '0')}
          </span>
          <div class="h-px flex-1 max-w-16 bg-accent-500/30" />
        </div>

        {/* Title */}
        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-6 font-heading leading-tight">
          {service.title}
        </h2>

        {/* Long description */}
        <p class="text-dark-300 text-base sm:text-lg leading-relaxed mb-8">
          {service.longDescription}
        </p>

        {/* Features list */}
        <ul class="space-y-3 mb-10">
          {service.features.map((feature) => (
            <li class="flex items-center gap-3 text-dark-200">
              <div class="w-5 h-5 rounded-full bg-accent-500/15 flex items-center justify-center shrink-0">
                <svg class="w-3 h-3 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                </svg>
              </div>
              <span class="text-sm sm:text-base">{feature}</span>
            </li>
          ))}
        </ul>

        {/* CTA */}
        <a
          href={`${base}/kontakt`}
          class="inline-flex items-center gap-2 px-7 py-3.5 bg-accent-500 hover:bg-accent-400 text-dark-950 rounded-xl text-sm font-semibold transition-all duration-300 hover:shadow-lg hover:shadow-accent-500/25 hover:-translate-y-0.5"
        >
          Jetzt anfragen
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
          </svg>
        </a>
      </div>

    </div>
  </div>
</section>

<style is:global>
  /* === Scroll-triggered reveal animation === */
  .service-reveal {
    opacity: 0;
    transform: translateY(40px);
    transition: opacity 0.8s cubic-bezier(0.22, 1, 0.36, 1), transform 0.8s cubic-bezier(0.22, 1, 0.36, 1);
  }
  .service-reveal.revealed {
    opacity: 1;
    transform: translateY(0);
  }
  /* Stagger the second element */
  .service-section .service-reveal:nth-child(2) {
    transition-delay: 0.15s;
  }

  /* === Sanfter Zoom-Effekt statt Parallax === */
  .service-parallax-img {
    transform: scale(1.08);
    transition: transform 6s cubic-bezier(0.22, 1, 0.36, 1);
  }
  .service-section.in-view .service-parallax-img {
    transform: scale(1);
  }

  /* === Mobile: no parallax, smaller spacing === */
  @media (max-width: 639px) {
    .service-section {
      min-height: auto;
      padding-top: 4rem;
      padding-bottom: 4rem;
    }
  }
</style>

<script>
  // === Scroll reveal ===
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('revealed');
        }
      });
    },
    { threshold: 0.15, rootMargin: '0px 0px -50px 0px' }
  );

  document.querySelectorAll('.service-reveal').forEach((el) => observer.observe(el));

  // === Zoom-in effect when section enters view ===
  const zoomObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('in-view');
        }
      });
    },
    { threshold: 0.1 }
  );
  document.querySelectorAll('.service-section').forEach((el) => zoomObserver.observe(el));

  // === Gallery auto-advance for multi-image services ===
  document.querySelectorAll('.service-section').forEach((section) => {
    const imgs = section.querySelectorAll<HTMLElement>('[data-gallery-img]');
    const dots = section.querySelectorAll<HTMLElement>('.service-gallery-dot');
    if (imgs.length <= 1) return;

    let current = 0;
    let interval: ReturnType<typeof setInterval>;

    function goTo(idx: number) {
      imgs.forEach((img, i) => {
        img.style.opacity = i === idx ? '1' : '0';
      });
      dots.forEach((dot, i) => {
        if (i === idx) {
          dot.classList.add('bg-accent-500', 'scale-125');
          dot.classList.remove('bg-white/30');
        } else {
          dot.classList.remove('bg-accent-500', 'scale-125');
          dot.classList.add('bg-white/30');
        }
      });
      current = idx;
    }

    function startAutoplay() {
      interval = setInterval(() => goTo((current + 1) % imgs.length), 4000);
    }

    dots.forEach((dot, i) => {
      dot.addEventListener('click', () => {
        clearInterval(interval);
        goTo(i);
        startAutoplay();
      });
    });

    startAutoplay();
  });
</script>
